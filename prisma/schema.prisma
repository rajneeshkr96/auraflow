// prisma/schema.prisma
generator client {
  provider      = "prisma-client"
  output        = "../app/generated/prisma"
  compilerBuild = "fast" // New in 7.3.0: options are "fast" or "small"
}

datasource db {
  provider = "postgresql"
  // Note: No 'url' field here; it's handled in prisma.config.ts
}

model User {
  id           String         @id @default(uuid())
  clerkId      String         @unique
  email        String         @unique
  firstname    String?
  lastname     String?
  createdAt    DateTime       @default(now())
  subscription Subscription?
  integrations Integration[]
  automations  Automation[]
  agents       Agent[]
  conversations Conversation[]
}

model Subscription {
  id     String            @id @default(uuid())
  userId String            @unique
  user   User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   SUBSCRIPTION_PLAN @default(FREE)
}

model Integration {
  id          String           @id @default(uuid())
  name        INTEGRATION_TYPE @default(INSTAGRAM)
  createdAt   DateTime         @default(now())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  token       String           // Page Access Token
  instagramId String?          @unique // Instagram Business Account ID
  pageId      String?          // Facebook Page ID (needed for messaging)
  expiresAt   DateTime?
}

model Automation {
  id        String   @id @default(uuid())
  name      String   @default("Untitled")
  createdAt DateTime @default(now())
  active    Boolean  @default(false)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  trigger   Trigger[]
  listener  Listener?
  posts     Post[]
  keywords  Keyword[]
}

model Agent {
  id             String    @id @default(uuid())
  name           String
  type           AGENT_TYPE @default(REPLY)
  prompt         String
  createdAt      DateTime  @default(now())
  
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listeners      Listener[]
}

model Trigger {
  id           String       @id @default(uuid())
  type         TRIGGER_TYPE
  automationId String
  automation   Automation   @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model Listener {
  id           String        @id @default(uuid())
  automationId String        @unique
  automation   Automation    @relation(fields: [automationId], references: [id], onDelete: Cascade)
  
  listener     LISTENER_TYPE @default(MESSAGE)
  
  // For Static Replies (classic)
  commentReply String?       
  dmReply      String?       

  // For Smart AI Agent
  agentId      String?
  agent        Agent?        @relation(fields: [agentId], references: [id])
}

model Keyword {
  id           String      @id @default(uuid())
  word         String
  automationId String?
  automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@unique([automationId, word])
}

model Post {
  id           String      @id @default(uuid())
  postid       String      // Instagram Post ID
  caption      String?
  media        String?
  mediaType    String?     // IMAGE, VIDEO, CAROUSEL_ALBUM
  automationId String?
  automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

// Analytics & History
model Conversation {
  id           String    @id @default(uuid())
  createdAt    DateTime  @default(now())
  
  // The Instagram User we are talking to
  recipientId  String    
  
  // The SaaS User who owns this conversation (via Integration usually, but linked to User for ease)
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages     Message[]
  
  @@unique([userId, recipientId]) // One conversation per recipient per SaaS user
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role           MESSAGE_ROLE // USER (them) or ASSISTANT (us)
  content        String
  createdAt      DateTime     @default(now())
  
  inputTokens    Int?         // for billing/stats
  outputTokens   Int?         // for billing/stats
}

enum SUBSCRIPTION_PLAN {
  FREE
  PRO
}

enum INTEGRATION_TYPE {
  INSTAGRAM
}

enum TRIGGER_TYPE {
  DM
  COMMENT
}

enum LISTENER_TYPE {
  SMART_AI
  MESSAGE
}

enum AGENT_TYPE {
  REPLY
  CLOSER
  CONTENT
}

enum MESSAGE_ROLE {
  USER
  ASSISTANT
  SYSTEM
}
